<div class="grid">
    <div class="col-12">
        <div class="card">
            <div class="textFilterPos">
                <h4 class="mg-l-9">Danh sách cư dân</h4>
            </div>
            <div class="grid p-pluid mt-2">
                <div class="formSearchText center-text-inpos w-35">
                    <input type="text" placeholder="Tìm kiếm theo tên cư dân, CCCD/hộ chiếu, SĐT... " name="searchProject" [(ngModel)]="search" 
                    (keyup.Enter)="onSearch($event)" (keyup)="isInputEmpty = search === ''" value="" class="StextSingle_Project">
                    <button class="iconbtnSearch"  *ngIf="!isInputEmpty"><span class="pi pi-times mg-t-10" style="font-size: 1rem" (click)="onClearInput()"></span></button>
                </div>
            </div>
            <div class="grid formgrid" [formGroup]="fSearch">
                <div class="field p-fluid center-text-inpos w-22-9">
                    <p-dropdown
                        [options]="lstProject"
                        placeholder="Khu đô thị"
                        emptyMessage="Không có dữ liệu."
                        [showClear]="true"
                        formControlName="ProjectId"
                        optionLabel="Name"
                        optionValue="Id"
                        (onChange)="onSelectProject($event)">
                    </p-dropdown>
                </div>
                <div class="field p-fluid center-text-inpos w-22-9">
                    <ng-select 
                        [items]="lstTower"
                        [virtualScroll]="true" 
                        [loading]="false" 
                        formControlName="TowerId"
                        placeholder="Tòa nhà"
                        bindLabel="Name" 
                        bindValue="Id"
                        (scrollToEnd)="fetchMoreTower()"
                        #selectTower
                        pDropdown
                        (change)="onSelectTower($event)">
                        <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                            <span [ngOptionHighlight]="search">{{item.Name}}</span>
                        </ng-template>
                    </ng-select>
                </div>
                <div class="field p-fluid center-text-inpos w-22-9">
                    <ng-select 
                        [items]="lstFloor"
                        [virtualScroll]="true" 
                        [loading]="false" 
                        formControlName="FloorId"
                        placeholder="Tầng"
                        bindLabel="Name" 
                        bindValue="Id"
                        (scrollToEnd)="fetchMoreFloor()"
                        #selectFloor
                        pDropdown
                        (change)="onSelectFloor($event)">
                        <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                            <span [ngOptionHighlight]="search">{{item.Name}}</span>
                        </ng-template>
                    </ng-select>
                </div>
                <div class="field p-fluid center-text-inpos w-22-9">
                    <ng-select 
                        [items]="lstApartment"
                        [virtualScroll]="true" 
                        [loading]="false" 
                        formControlName="ApartmentId"
                        placeholder="Căn hộ"
                        bindLabel="Name" 
                        bindValue="Id"
                        (scrollToEnd)="fetchMore()"
                        #selectApartment
                        pDropdown>
                        <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                            <span [ngOptionHighlight]="search">{{item.Name}}</span>
                        </ng-template>
                    </ng-select>
                </div>
                <div class="field p-fluid center-text-inpos w-20">
                    <p-dropdown
                        [options]="lstUserRole"
                        placeholder="Vai trò dân cư"
                        emptyMessage="Không có dữ liệu."
                        [showClear]="true"
                        formControlName="Type"
                        optionLabel="label"
                        optionValue="value">
                    </p-dropdown>
                </div>
                <div class="field p-fluid center-text-inpos w-20">
                    <p-dropdown
                        [options]="staying"
                        placeholder="Tình trạng nhân khẩu"
                        emptyMessage="Không có dữ liệu."
                        [showClear]="true"
                        formControlName="residentStatus"
                        optionLabel="label"
                        optionValue="value">
                    </p-dropdown>
                </div>
                <div class="field p-fluid center-text-inpos w-20">
                    <p-dropdown
                        [options]="statusOption"
                        placeholder="Trạng thái cư dân"
                        emptyMessage="Không có dữ liệu."
                        [showClear]="true"
                        formControlName="Status"
                        optionLabel="label"
                        optionValue="value">
                    </p-dropdown>
                </div>
                <div class="field p-fluid center-text-inpos w-20">
                    <p-dropdown
                        [options]="[
                        { label: 'Có tài khoản', value: true},
                        { label: 'Không có tài khoản', value: false},
                        { label: 'Tất cả tài khoản', value: null}
                        ]"
                        placeholder="Tất cả tài khoản"
                        emptyMessage="Không có dữ liệu."
                        [showClear]="true"
                        formControlName="IsAccount"
                        optionLabel="label"
                        optionValue="value">
                    </p-dropdown>
                </div>
                <section class="FilterProject ml-3 mt-3 mb-3">
                    <div class="addProjectList btn-options">
                        <button type="button" pButton icon="pi pi-filter" label="Lọc" (click)="onSelect()"></button>
                    </div>
                </section>
            </div>
            <section class="FilterProject mb-2">
                <p-toggleButton [(ngModel)]="idFrozen" [onIcon]="'pi pi-lock'" offIcon="pi pi-lock-open" [onLabel]="'Thao tác'" 
                    offLabel="Thao tác" [style]="{'width': '8rem'}"></p-toggleButton>
                <div class="addProjectList btn-options">
                    <button type="button" pButton icon="fa fa-plus-circle" label="Thêm mới" routerLink="/category/resident/create"></button>
                </div>
                <div class="addProjectList mr-2 btn-orange absolute-btn">
                    <button #btn type="button" pButton icon="pi pi-chevron-down" label="Hành động" (click)="menu.toggle($event)" style="width:auto"></button>
                    <p-tieredMenu #menu [model]="menuItems" [popup]="true"></p-tieredMenu>
                </div>
                <div class="addProjectList mr-2 btn-options btn-green">
                    <button type="button" pButton icon="pi ft-download" label="Tải xuống" ></button>
                </div>
                <div class="addProjectList mr-2 btn-options btn-yellow">
                    <button type="button" pButton icon="ft-upload" label="Tải lên" routerLink="/category/tower/upload"></button>
                </div>
                <div class="addProjectList btn-options mr-2">
                    <button type="button" pButton icon="pi pi-refresh" label="Làm mới" (click)="btnReset()"></button>
                </div>
            </section>
            <p-table
                [value]="lstResident"
                [paginator]="true"
                [rows]="10"
                [showCurrentPageReport]="true"
                [tableStyle]="{ 'min-width': '50rem' }"
                currentPageReportTemplate="Hiển thị {first} đến {last} của {totalRecords} mục nhập"
                [rowsPerPageOptions]="[10, 25, 50]"
                [loading]="isLoadingTable"
                [scrollable]="true"
                [(selection)]="selectedItems">
                <ng-template pTemplate="header">
                    <tr class="th-table">
                        <th rowspan="2">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th rowspan="2" >STT</th>
                        <th class="min-w-100" rowspan="2">Tên cư dân </th>
                        <th rowspan="2">Số điện thoại</th>
                        <th rowspan="2">CCCD/Hộ chiếu</th>
                        <th rowspan="2" >Ngày sinh</th>
                        <th class="text-center min-w-200 pd-resident-header" colspan="7"> Thông tin căn Hộ</th>
                        <th rowspan="2" class="min-w-150 text-center"  alignFrozen="right" pFrozenColumn [frozen]="idFrozen" [ngClass]="{'color-bg': idFrozen}">Thao tác</th>
                    </tr>
                    <tr class="th-table">
                        <th rowspan="1" id="Name" name="Name" class="min-w-200">Căn hộ</th>
                        <th rowspan="1" id="roleName" class="min-w-150">Vai trò</th>
                        <th rowspan="1" id="relationshipOptionName" class="min-w-150">Quan hệ với chủ hộ</th>
                        <th rowspan="1" id="stayingName" class="min-w-200">Tình trạng nhân khẩu</th>
                        <th rowspan="1" id="statusOptionName" class="min-w-100">Trạng thái</th>
                        <th rowspan="1" id="DateStart" class="min-w-100">Ngày đến</th>
                        <th rowspan="1" id="DateEnd" class="min-w-100">Ngày đi</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-Resident let-rowIndex="rowIndex">
                    <tr *ngFor="let listItem of Resident.listApartmentMaps let isFirst = first"  class="td-table">
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">
                            <p-tableCheckbox [value]="Resident"></p-tableCheckbox>
                        </td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">{{ rowIndex + 1 }}</td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">{{ Resident.FullName }}</td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">{{ Resident.Phone }}</td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">{{ Resident.CardId }}</td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan">{{ Resident.Birthday | date:'dd/MM/yyyy' }}</td>
                        <td>{{ listItem?.FullName}}</td>
                        <td>{{ listItem?.roleName }}</td>
                        <td>{{ listItem?.relationshipOptionName }}</td>
                        <td>{{ listItem?.stayingName }}</td>
                        <td>{{ listItem?.statusOptionName }}</td>
                        <td>{{ listItem?.DateStart | date:'dd/MM/yyyy' }}</td>
                        <td>{{ listItem?.DateEnd | date:'dd/MM/yyyy' }}</td>
                        <td *ngIf="isFirst" [rowSpan]="Resident.rowSpan" alignFrozen="right" pFrozenColumn [frozen]="idFrozen" [ngClass]="{'color-bg': idFrozen}">
                            <button *ngIf="!Resident.IsAccount" pTooltip="Thêm tài khoản cho cư dân"  pButton pRipple icon="pi pi-user-plus" class="p-button-rounded p-button-info mr-2 mt-2"
                                (click)="onOpenDialog(Resident.Id)">
                            </button>
                            <button *ngIf="Resident.IsAccount" pButton pRipple icon="pi pi-arrow-right-arrow-left" pTooltip="Đổi mật khẩu cư dân" class="p-button-rounded mr-2 mt-2"
                                (click)="onOpenDialogResetPassword(Resident)">
                            </button>
                            <button pButton pRipple icon="pi pi-eye" pTooltip="Chi tiết thông tin cư dân" class="p-button-rounded p-button-secondary mr-2 mt-2"
                                (click)="onOpenDialogDetail(Resident)">
                            </button>
                            <button *ngIf="Resident?.user?.Status == 98 && Resident.IsAccount === true" pButton pRipple icon="pi pi-lock-open" pTooltip="Mở khóa tài khoản cư dân" 
                                class="p-button-rounded p-toggleButton-lock p-button-info mr-2 mt-2" (click)="onLockAccount(Resident.Id)">
                            </button>
                            <button *ngIf="Resident?.user?.Status == 1 && Resident.IsAccount === true" pButton pRipple icon="pi pi-lock" pTooltip="Khóa tài khoản cư dân" 
                                class="p-button-rounded p-toggleButton-lock p-button-warning mr-2 mt-2" (click)="onLockAccount(Resident.Id)">
                            </button>
                            <button pButton pRipple icon="pi pi-credit-card" pTooltip="Danh sách thẻ của cư dân" 
                                class="p-button-rounded p-toggleButton-lock p-button-card mr-2 mt-2" (click)="onOpenDialogCardAccepted(Resident.Id)">
                            </button>
                            <button *ngIf="!Resident.Account" pButton pRipple icon="pi pi-pencil" pTooltip="Sửa thông tin cư dân" class="p-button-rounded p-button-success mr-2 mt-2"
                                routerLink="/category/resident/update/{{Resident.Id}}">
                            </button>
                            <button *ngIf="Resident.Account" pButton pRipple icon="pi pi-pencil" pTooltip="Duyệt tài khoản căn hộ cư dân" class="p-button-rounded p-button-danger mr-2 mt-2"
                                routerLink="/category/resident/update/{{Resident.Id}}">
                            </button>
                            <button pButton pRipple icon="pi pi-trash" pTooltip="Xóa cư dân" class="p-button-rounded p-button-danger mr-2 mt-2"
                                image.png (click)="onDelete(Resident.Id)">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr class="text-center">
                                 <td colspan="7" class="text-center text-danger">No Residents found.</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<p-toast></p-toast>
<p-confirmDialog class="custom-toast"></p-confirmDialog>
